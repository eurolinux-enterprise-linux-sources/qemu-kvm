From 05030570d04300e30bf4ac64ee6c3738f7d9ba2b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Daniel=20P=2E=20Berrang=C3=A9?= <berrange@redhat.com>
Date: Wed, 9 May 2018 09:06:29 +0100
Subject: [PATCH 1/3] i386: define the 'ssbd' CPUID feature bit (CVE-2018-3639)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1574074
Brew: https://brewweb.engineering.redhat.com/brew/taskinfo?taskID=16150672

New microcode introduces the "Speculative Store Bypass Disable"
CPUID feature bit. This needs to be exposed to guest OS to allow
them to protect against CVE-2018-3639.

Signed-off-by: Daniel P. Berrang√© <berrange@redhat.com>
---
 target-i386/cpu.h   | 1 +
 target-i386/cpuid.c | 2 +-
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/target-i386/cpu.h b/target-i386/cpu.h
index 06ed95c42d..bd750019f3 100644
--- a/target-i386/cpu.h
+++ b/target-i386/cpu.h
@@ -493,6 +493,7 @@
 #define CPUID_7_0_EBX_SMAP     (1 << 20)
 
 #define CPUID_7_0_EDX_SPEC_CTRL     (1U << 26) /* Indirect Branch - Restrict Speculation */
+#define CPUID_7_0_EDX_SPEC_CTRL_SSBD  (1U << 31) /* Speculative Store Bypass Disable */
 
 #define CPUID_8000_0008_EBX_IBPB    (1U << 12) /* Indirect Branch Prediction Barrier */
 
diff --git a/target-i386/cpuid.c b/target-i386/cpuid.c
index f51c7007ba..fb43bff0c1 100644
--- a/target-i386/cpuid.c
+++ b/target-i386/cpuid.c
@@ -89,7 +89,7 @@ static const char *cpuid_7_0_edx_feature_name[] = {
     NULL, NULL, NULL, NULL,
     NULL, NULL, NULL, NULL,
     NULL, NULL, "spec-ctrl", "stibp",
-    NULL, "arch-facilities", NULL, NULL,
+    NULL, "arch-facilities", NULL, "ssbd",
 };
 
 static const char *cpuid_apm_edx_feature_name[] = {
-- 
2.13.6

