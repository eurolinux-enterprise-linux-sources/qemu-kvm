From 96acdfd33954735337236cecafcc91143706ba23 Mon Sep 17 00:00:00 2001
From: Xiao Wang <jasowang@redhat.com>
Date: Fri, 11 Dec 2015 08:49:30 -0500
Subject: [PATCH 4/4] pcnet: fix rx buffer overflow(CVE-2015-7512)

RH-Author: Xiao Wang <jasowang@redhat.com>
Message-id: <1449823770-36267-2-git-send-email-jasowang@redhat.com>
Patchwork-id: 68539
O-Subject: [RHEL6.8/6.7z qemu-kvm PATCH V2 2/2] pcnet: fix rx buffer overflow(CVE-2015-7512)
Bugzilla: 1286597 1287950
RH-Acked-by: John Snow <jsnow@redhat.com>
RH-Acked-by: Jeff Nelson <jenelson@redhat.com>
RH-Acked-by: Michael S. Tsirkin <mst@redhat.com>

Bugzilla: 1286567 1287950
Brew Build: https://brewweb.devel.redhat.com/taskinfo?taskID=10222858
Test status: Tested by myself.
Upstream Status: 8b98a2f07175d46c3f7217639bd5e03f2ec56343
Notes: Conflicts since hw/pcnet.c were renamed to hw/net/pcnet.c upstream

Backends could provide a packet whose length is greater than buffer
size. Check for this and truncate the packet to avoid rx buffer
overflow in this case.

Cc: Prasad J Pandit <pjp@fedoraproject.org>
Cc: qemu-stable@nongnu.org
Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
Signed-off-by: Jason Wang <jasowang@redhat.com>
Signed-off-by: Jeff E. Nelson <jen@redhat.com>
---
 hw/pcnet.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/hw/pcnet.c b/hw/pcnet.c
index bb1d892..eab8430 100644
--- a/hw/pcnet.c
+++ b/hw/pcnet.c
@@ -1107,6 +1107,12 @@ ssize_t pcnet_receive(VLANClientState *nc, const uint8_t *buf, size_t size_)
             int pktcount = 0;
 
             if (!s->looptest) {
+                if (size > 4092) {
+#ifdef PCNET_DEBUG_RMD
+                    fprintf(stderr, "pcnet: truncates rx packet.\n");
+#endif
+                    size = 4092;
+                }
                 memcpy(src, buf, size);
                 /* no need to compute the CRC */
                 src[size] = 0;
-- 
2.1.0

